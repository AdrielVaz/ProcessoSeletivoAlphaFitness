<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="/styles/index.css">
    <link rel="stylesheet" href="/styles/card.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <title>Processo Seletivo Rede Alpha Fitness</title>
</head>

<body>
    <header>
        <div class="logo-container">
            <h2>Sistema Alpha Fitness</h2>
        </div>
        <div class="icon-container">
            <div class="icon">
                <i class="fas fa-dumbbell"></i>
            </div>
        </div>
    </header>
    <div class="tabela-container">
        <h1>Dados do Excel</h1>

        <!-- Controles de paginação -->
        <div class="paginacao-container">
            <button id="btnAnterior" onclick="mudarPagina(paginaAtual - 1)">◀ Anterior</button>
            <span id="infoPagina">Página 1 de 1</span>
            <button id="btnProximo" onclick="mudarPagina(paginaAtual + 1)">Próximo ▶</button>
        </div>

        <!-- Filtro geral -->
        <div class="filtro-container">
            <div class="filtro-item">
                <label for="filtro-nome">Filtrar por Nome:</label>
                <input type="text" id="filtro" placeholder="Digite o nome para filtrar">
            </div>
            <div class="filtro-item">
                <label for="filtro-email">Filtrar por Email:</label>
                <input type="text" id="filtro-email" placeholder="Digite Email para filtrar">
            </div>
            <div class="filtro-item">
                <label for="cpf">Filtrar por CPF:</label>
                <input type="text" id="filtro-cpf" placeholder="000.000.000-00" maxlength="14">
            </div>
            <div class="filtro-item">
                <label for="ordenar">Ordenar por:</label>
                <select id="ordenar">
                    <option value="mais-recentes">Mais recentes</option>
                    <option value="mais-antigos">Mais antigos</option>
                    <option value="a-z">A → Z</option>
                    <option value="z-a">Z → A</option>
                </select>
            </div>
            <div class="filtro-item">
                <label for="filtro-numero">Filtrar por Número:</label>
                <input type="number" id="filtro-numero" placeholder="Digite Número para filtrar">
            </div>
            <div class="filtro-item">
                <label for="filtro-id">Filtrar por ID:</label>
                <input type="text" id="filtro-id" placeholder="Digite ID para filtrar">
            </div>
        </div>

        <div id="loading" style="display: none; text-align: center; margin: 20px 0;">
            <i id="spinner" class="fas fa-spinner fa-spin" style="font-size: 2em; color: #ff6b00;"></i>
            <div style="margin-top: 10px;">Carregando...</div>
        </div>
        <div id="error" style="display: none; color: red;"></div>

        <div class="tabela-rolavel">
            <table id="tabela">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Nome</th>
                        <th>Número</th>
                        <th>Email</th>
                        <th>CPF</th>
                        <th>Timestamp</th>
                    </tr>
                </thead>
                <tbody>
                    <!-- dados -->
                </tbody>
            </table>
        </div>
    </div>

    <!-- Card de Estatísticas -->
    <div id="statsCard" class="stats-card" style="display: none;">
        <div class="stats-title">
            <i class="fas fa-database"></i>
            TOTAL DE REGISTROS
        </div>
        <div class="stats-count" id="totalCount">0</div>
        <div class="stats-info">
            <span>Filtrados: <span id="filteredCount">0</span></span>
        </div>
        <div class="stats-update" id="lastUpdate">
            Atualizado: <span id="updateTime">--:--:--</span>
        </div>
    </div>

    <!-- Botão de estatísticas (mobile) -->
    <div id="statsToggle" class="stats-toggle">
        <i class="fas fa-chart-bar"></i>
    </div>

    <script>
        const tabela = document.getElementById("tabela");
        const filtroInput = document.getElementById("filtro");
        const filtroEmail = document.getElementById("filtro-email");
        const filtroCpf = document.getElementById("filtro-cpf");
        const filtroNumero = document.getElementById("filtro-numero");
        const filtroId = document.getElementById("filtro-id");
        const ordenarSelect = document.getElementById("ordenar");

        // Elementos de paginação
        const btnAnterior = document.getElementById("btnAnterior");
        const btnProximo = document.getElementById("btnProximo");
        const infoPagina = document.getElementById("infoPagina");

        // Elementos do card de estatísticas
        const statsCard = document.getElementById("statsCard");
        const totalCount = document.getElementById("totalCount");
        const filteredCount = document.getElementById("filteredCount");
        const updateTime = document.getElementById("updateTime");

        // Variáveis globais
        let dadosOriginais = [];
        let dadosFiltradosAtuais = [];
        let paginaAtual = 1;
        let totalPaginas = 1;
        let totalRegistros = 0;

        function formatarDataHora(data) {
            return new Date(data).toLocaleString('pt-BR');
        }

        function atualizarEstatisticas() {
            const total = totalRegistros;
            const filtrados = dadosFiltradosAtuais.length;

            totalCount.textContent = total;
            filteredCount.textContent = filtrados;
            updateTime.textContent = new Date().toLocaleTimeString('pt-BR');

            if (total > 0) {
                statsCard.style.display = 'block';
            }

            totalCount.classList.add('pulse');
            setTimeout(() => totalCount.classList.remove('pulse'), 1000);
        }

        function atualizarPaginacao() {
            infoPagina.textContent = `Página ${paginaAtual} de ${totalPaginas}`;
            btnAnterior.disabled = paginaAtual <= 1;
            btnProximo.disabled = paginaAtual >= totalPaginas;
        }

        function renderizarTabela(dados) {
            const tbody = tabela.querySelector("tbody");
            tbody.innerHTML = "";
            dadosFiltradosAtuais = dados;

            if (dados.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="sem-dados">Nenhum dado encontrado</td></tr>`;
                atualizarEstatisticas();
                return;
            }

            dados.forEach(item => {
                const row = document.createElement("tr");
                row.innerHTML = `
                    <td>${item.id}</td>
                    <td>${item.nome}</td>
                    <td>${item.numero}</td>
                    <td>${item.email}</td>
                    <td>${item.cpf}</td>
                    <td>${formatarDataHora(item.timestamp)}</td>
                `;
                tbody.appendChild(row);
            });

            atualizarEstatisticas();
        }




        function aplicarFiltros() {
            paginaAtual = 1; // Sempre volta para página 1 ao filtrar/ordenar
            buscarDadosComFiltros();
        }

        function buscarDadosComFiltros(page = 1) {
            const loading = document.getElementById("loading");
            const error = document.getElementById("error");

            loading.style.display = "block";
            error.style.display = "none";

            const params = new URLSearchParams({
                page: page,
                per_page: 100,
                filtro_nome: filtroInput.value,
                filtro_email: filtroEmail.value,
                filtro_cpf: filtroCpf.value.replace(/\D/g, ""),
                filtro_numero: filtroNumero.value,
                filtro_id: filtroId.value,
                ordenar: ordenarSelect.value
            });

            fetch(`/api/dados?${params}`)
                .then(response => {
                    if (!response.ok) throw new Error("Erro ao buscar dados");
                    return response.json();
                })
                .then(response => {
                    dadosOriginais = response.data;
                    totalRegistros = response.pagination.total;
                    totalFiltrados = response.pagination.total_filtrados;
                    totalPaginas = response.pagination.total_pages;
                    paginaAtual = response.pagination.page;

                    renderizarTabela(dadosOriginais);
                    atualizarPaginacao();
                    console.log(`✅ Página ${paginaAtual}/${totalPaginas} | Filtrados: ${totalFiltrados}/${totalRegistros} | Ordenação: ${ordenarSelect.value}`);
                })
                .catch(err => {
                    error.textContent = "Erro: " + err.message;
                    error.style.display = "block";
                    console.error("Erro ao buscar dados:", err);
                })
                .finally(() => {
                    loading.style.display = "none";
                });
        }

        function mudarPagina(novaPagina) {
            if (novaPagina < 1 || novaPagina > totalPaginas) return;
            buscarDadosComFiltros(novaPagina); // Mantém filtros e ordenação
        }

        // event listeners:
        filtroInput.addEventListener("input", debounce(aplicarFiltros, 300));
        filtroEmail.addEventListener("input", debounce(aplicarFiltros, 300));
        filtroCpf.addEventListener("input", debounce(aplicarFiltros, 300));
        filtroNumero.addEventListener("input", debounce(aplicarFiltros, 300));
        filtroId.addEventListener("input", debounce(aplicarFiltros, 300));
        ordenarSelect.addEventListener("change", aplicarFiltros);

        // Inicialização 
        buscarDadosComFiltros(1);

        // Atualizar ao focar na janela
        window.addEventListener('focus', () => {
            buscarDadosComFiltros(paginaAtual);
        });

        // Função debounce 
        function debounce(func, wait) {
            let timeout;
            return function executedFunction(...args) {
                const later = () => {
                    clearTimeout(timeout);
                    func(...args);
                };
                clearTimeout(timeout);
                timeout = setTimeout(later, wait);
            };
        }

        const statsToggle = document.getElementById("statsToggle");
        statsToggle.addEventListener("click", () => {
            if (statsCard.style.display === "none" || statsCard.style.display === "") {
                statsCard.style.display = "block";
            } else {
                statsCard.style.display = "none";
            }
        });
        // Máscara para o campo CPF
        const cpfInput = document.getElementById("filtro-cpf");
        cpfInput.addEventListener("input", function (e) {
            let value = cpfInput.value;
            value = value.replace(/\D/g, "");

            if (value.length > 3) value = value.replace(/(\d{3})(\d)/, "$1.$2");
            if (value.length > 6) value = value.replace(/(\d{3})\.(\d{3})(\d)/, "$1.$2.$3");
            if (value.length > 9) value = value.replace(/(\d{3})\.(\d{3})\.(\d{3})(\d)/, "$1.$2.$3-$4");

            cpfInput.value = value.slice(0, 14);
        });

        // Atualizar ao focar na janela - MANTER FILTROS ATUAIS
        window.addEventListener('focus', () => {
            buscarDadosComFiltros(paginaAtual);
        });


    </script>
</body>

</html>